<div class="main-container">
  <table>
    <thead>
      <tr>
        <th class="role-column">Role</th>
        <th class="description-column">Role Description</th>
        <th class="permission-column">Permission</th>
        <th class="actions-column"></th>
      </tr>
    </thead>
    <ng-container *ngIf="loadingData">
      <tr>
        <td colspan="5">
          <app-insytha-skeleton-loader
            [count]="1"
            [height]="'15rem'"
            [width]="'100%'"
            [border_radius]="'1rem'"
          ></app-insytha-skeleton-loader>
        </td>
      </tr>
    </ng-container>

    <tbody>
      <ng-container *ngIf="!loadingData">
        <tr *ngFor="let roles of role">
          <td class="role-column">{{ roles.roleName }}</td>
          <td class="description-column">{{ roles.roleDescription }}</td>
          <td class="permission-column">
            {{ formatPermissionsForDisplay(roles.permissions) }}
          </td>
          <td class="actions-column">
            <div class="status-content">
              <div class="icons">
                <img
                  src="/images/edit.png"
                  alt=""
                  (click)="openEditModal(roles)"
                />
                <img
                  src="/images/trash.png"
                  alt=""
                  (click)="openDeleteModal(roles)"
                />
              </div>
            </div>
          </td>
        </tr>
        <tr *ngIf="role.length === 0">
          <td colspan="4" style="text-align: center; padding: 20px">
            No roles found. Add a role to get started.
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>

  <div
    *ngIf="showModal || isEditModal || isDeleteModal || isSuccessModal"
    class="modal-overlay"
    (click)="closeModal()"
  >
    <!-- Add Modal -->
    <div *ngIf="showModal" class="add-modal" (click)="$event.stopPropagation()">
      <div class="header">
        <div class="left"><h1>Add Role</h1></div>
        <button class="close-btn" (click)="closeModal()">×</button>
      </div>
      <form class="form" [formGroup]="roleForm" (ngSubmit)="addRole()">
        <div class="form-details">
          <label for="roleName">Role Name</label>
          <input
            type="text"
            id="roleName"
            formControlName="roleName"
            placeholder="Enter role"
          />
        </div>

        <div class="form-details">
          <label for="roleDescription">Role Description</label>
          <input
            type="text"
            id="roleDescription"
            formControlName="roleDescription"
            placeholder="Describe Role"
          />
        </div>

        <div class="form-details">
          <label for="permissions">Permissions</label>
          <div class="permission-dropdown-container">
            <div class="permission-display" (click)="$event.stopPropagation()">
              {{ getSelectedPermissionsDisplay() }}
            </div>

            <div class="permission-categories">
              <div
                *ngFor="let category of permissionCategories; let i = index"
                class="permission-category"
              >
                <div
                  class="category-header"
                  (click)="toggleDropdown(i, $event)"
                >
                  <img
                    src="/images/arrow-down.png"
                    alt="dropdown arrow"
                    class="dropdown-icon"
                    [class.rotated]="category.isOpen"
                  />
                  <span>{{ category.name }}</span>
                </div>

                <div *ngIf="category.isOpen" class="category-options">
                  <div
                    *ngFor="let option of category.options; let j = index"
                    class="permission-option"
                    (click)="onPermissionChange(i, j)"
                  >
                    <input
                      type="checkbox"
                      [checked]="option.selected"
                      (click)="$event.stopPropagation()"
                      (change)="onPermissionChange(i, j)"
                    />
                    <label>{{ option.label }}</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="primary-btn" (click)="closeModal()">
            Cancel
          </button>
          <button
            type="submit"
            class="secondary-btn"
            [disabled]="roleForm.invalid"
          >
            <span *ngIf="!isButtonLoading">Add Role</span>
            <span *ngIf="isButtonLoading" class="button-loader">
              <span class="spinner"></span>
              Adding...
            </span>
          </button>
        </div>
      </form>
    </div>

    <!-- Edit Modal -->
    <div
      *ngIf="isEditModal"
      class="edit-modal"
      (click)="$event.stopPropagation()"
    >
      <div class="header">
        <div class="left"><h1>Edit Role</h1></div>
        <button class="close-btn" (click)="closeModal()">×</button>
      </div>
      <form class="form" [formGroup]="roleForm" (ngSubmit)="updateRole()">
        <div class="form-details">
          <label for="editRoleName">Role Name</label>
          <input
            type="text"
            id="editRoleName"
            formControlName="roleName"
            placeholder="Enter role"
          />
        </div>

        <div class="form-details">
          <label for="editDescription">Role Description</label>
          <input
            type="text"
            id="editDescription"
            formControlName="roleDescription"
            placeholder="Describe Role"
          />
        </div>

        <div class="form-details">
          <label for="editPermissions">Permissions</label>
          <div class="permission-dropdown-container">
            <div class="permission-display" (click)="$event.stopPropagation()">
              {{ getSelectedPermissionsDisplay() }}
            </div>

            <div class="permission-categories">
              <div
                *ngFor="let category of permissionCategories; let i = index"
                class="permission-category"
              >
                <div
                  class="category-header"
                  (click)="toggleDropdown(i, $event)"
                >
                  <img
                    src="/images/arrow-down.png"
                    alt="dropdown arrow"
                    class="dropdown-icon"
                    [class.rotated]="category.isOpen"
                  />
                  <span>{{ category.name }}</span>
                </div>

                <div *ngIf="category.isOpen" class="category-options">
                  <div
                    *ngFor="let option of category.options; let j = index"
                    class="permission-option"
                    (click)="onPermissionChange(i, j)"
                  >
                    <input
                      type="checkbox"
                      [checked]="option.selected"
                      (click)="$event.stopPropagation()"
                      (change)="onPermissionChange(i, j)"
                    />
                    <label>{{ option.label }}</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button class="primary-btn" type="button" (click)="closeModal()">
            Cancel
          </button>
          <button type="submit" class="secondary-btn">
            <span *ngIf="!isButtonLoading">Update</span>
            <span *ngIf="isButtonLoading" class="button-loader">
              <span class="spinner"></span>
              Updating...
            </span>
          </button>
        </div>
      </form>
    </div>

    <!-- Delete Confirmation Modal -->
    <div
      *ngIf="isDeleteModal"
      class="warning-modal"
      (click)="$event.stopPropagation()"
    >
      <div class="top">
        <div class="images" style="background-color: #ffe5e5">
          <img src="/images/trash-red.png" alt="" />
        </div>
        <h1>Warning</h1>
        <h4>
          Are you sure you want to delete the "{{
            selectedRoleForDelete?.roleName
          }}" role ? from the system?
        </h4>
      </div>
      <div class="bottom-modal">
        <button (click)="closeModal()" class="primary-btn">Cancel</button>
        <button type="submit" class="secondary-btn" (click)="deleteRole()">
          <span *ngIf="!isButtonLoading">Delete</span>
          <span *ngIf="isButtonLoading" class="button-loader">
            <span class="spinner"></span>
            Deleting...
          </span>
        </button>
      </div>
    </div>

    <div *ngIf="isSuccessModal" class="warning-modal">
      <div class="top">
        <div class="images" style="background-color: #e3fce4">
          <img src="/images/tick-circle-green.png" alt="" />
        </div>
        <h1>Success</h1>
        <h4>{{ successMessage }}</h4>
      </div>
      <div class="bottom-modal">
        <button (click)="closeModal()" class="primary-btn">Cancel</button>
      </div>
    </div>
  </div>
</div>
